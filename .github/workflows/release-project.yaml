---
name: Release Panther project

on:
    workflow_dispatch:
        inputs:
            target_branch:
                description: Target branch for the release.
                required: true
            version:
                description: New version (used for tag and package versioning).
                required: true
            release_name:
                description: Name of the release to be created. Version in the first place is recommended (e.g. `2.0.0-alpha`).
                required: true
            automatic_mode:
                type: boolean
                default: false
                description: Automatically merge PR and create release.
            prerelease:
                type: boolean
                default: false
                description: Mark the release as a prerelease.

jobs:
    get_date:
        name: Get current date
        runs-on: ubuntu-22.04
        outputs:
            date: ${{ steps.get_current_date.outputs.date }}
        steps:
            - name: Get current date
              id: get_current_date
              run: echo "::set-output name=date::$(date +'%Y%m%d')"

    release_panther_msgs:
        name: Release panther_msgs repository
        runs-on: ubuntu-22.04
        steps:
            - name: Trigger repository release workflow
              uses: convictional/trigger-workflow-and-wait@v1.6.1
              with:
                  owner: husarion
                  repo: panther_msgs
                  github_token: ${{ secrets.GH_PAT }}
                  workflow_file_name: release-repository.yaml
                  ref: ros2-automatize-release-process #${{ github.event.inputs.target_branch }}
                  wait_interval: 10
                  client_payload: |
                      {
                        "target_branch": "${{ github.event.inputs.target_branch }}",
                        "version": "${{ github.event.inputs.version }}",
                        "release_name": "${{ github.event.inputs.release_name }}",
                        "automatic_mode": ${{ github.event.inputs.automatic_mode }},
                        "prerelease": ${{ github.event.inputs.prerelease }}
                      }

    release_panther_ros:
        name: Release panther_ros repository
        needs: release_panther_msgs
        runs-on: ubuntu-22.04
        steps:
            - name: Trigger panther_ros release workflow
              uses: convictional/trigger-workflow-and-wait@v1.6.1
              with:
                  owner: husarion
                  repo: panther_ros
                  github_token: ${{ secrets.GITHUB_TOKEN }} # Use the default GITHUB_TOKEN for local repository
                  workflow_file_name: release-repository.yaml
                  ref: ros2-automatize-release-process # ${{ github.event.inputs.target_branch }}
                  wait_interval: 10
                  client_payload: |
                      {
                        "target_branch": "${{ github.event.inputs.target_branch }}",
                        "version": "${{ github.event.inputs.version }}",
                        "release_name": "${{ github.event.inputs.release_name }}",
                        "automatic_mode": ${{ github.event.inputs.automatic_mode }},
                        "prerelease": ${{ github.event.inputs.prerelease }}
                      }

    release_panther_docker:
        name: Release panther-docker repository
        needs:
            - release_panther_ros
            - get_date
        runs-on: ubuntu-22.04
        steps:
            - name: Trigger repository release workflow
              uses: convictional/trigger-workflow-and-wait@v1.6.1
              with:
                  owner: husarion
                  repo: panther-docker
                  github_token: ${{ secrets.GH_PAT }}
                  workflow_file_name: release-repository.yaml
                  ref: ros2-automatize-release-process #${{ github.event.inputs.target_branch }}
                  wait_interval: 10
                  client_payload: |
                      {
                        "target_branch": "${{ github.event.inputs.target_branch }}",
                        "version": "${{ github.event.inputs.version }}",
                        "date": "${{ needs.get_date.outputs.date }}",
                        "release_name": "${{ github.event.inputs.release_name }}",
                        "automatic_mode": ${{ github.event.inputs.automatic_mode }},
                        "prerelease": ${{ github.event.inputs.prerelease }}
                      }

    build_and_push_docker_images:
        name: Build panther docker images
        needs:
            - release_panther_docker
            - get_date
        runs-on: ubuntu-22.04
        steps:
            - name: Trigger repository build workflow
              uses: convictional/trigger-workflow-and-wait@v1.6.1
              with:
                  owner: husarion
                  repo: panther-docker
                  github_token: ${{ secrets.GH_PAT }}
                  workflow_file_name: ros-docker-image.yaml
                  ref: ros2-automatize-release-process #${{ github.event.inputs.target_branch }}
                  wait_interval: 10
                  client_payload: |
                      {
                        "build_type": "stable",
                        "target_distro": "humble",
                        "target_release": "${{ github.event.inputs.version }}",
                        "target_date": "${{ needs.get_date.outputs.date }}"
                      }

    release_panther_rpi_os_image:
        name: Release panther-rpi-os-image repository
        needs:
            - release_panther_docker
        runs-on: ubuntu-22.04
        steps:
            - name: Trigger repository release workflow
              uses: convictional/trigger-workflow-and-wait@v1.6.1
              with:
                  owner: husarion
                  repo: panther-rpi-os-image
                  github_token: ${{ secrets.GH_PAT }}
                  workflow_file_name: release-repository.yaml
                  ref: ros2-automatize-release-process #${{ github.event.inputs.target_branch }}
                  wait_interval: 10
                  client_payload: |
                      {
                        "target_branch": "${{ github.event.inputs.target_branch }}",
                        "version": "${{ github.event.inputs.version }}",
                        "release_name": "${{ github.event.inputs.release_name }}",
                        "automatic_mode": ${{ github.event.inputs.automatic_mode }},
                        "prerelease": ${{ github.event.inputs.prerelease }}
                      }

    build_and_publish_rpi_image:
        name: Build panther docker images
        needs:
            - release_panther_rpi_os_image
        runs-on: ubuntu-22.04
        steps:
            - name: Trigger repository build workflow
              uses: convictional/trigger-workflow-and-wait@v1.6.1
              with:
                  owner: husarion
                  repo: panther-rpi-os-image
                  github_token: ${{ secrets.GH_PAT }}
                  workflow_file_name: build_and_deploy_image.yaml
                  ref: ros2-automatize-release-process #${{ github.event.inputs.target_branch }}
                  wait_interval: 10
                  client_payload: |
                      {
                        "dev_image": "false",
                        "panther_codebase_version": "${{ github.event.inputs.version }}",
                        "image_tag": "${{ github.event.inputs.release_name }}",
                      }
