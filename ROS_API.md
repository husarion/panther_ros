# ROS API

> [!IMPORTANT]
> **Beta Release**
>
> Please be advised that the software you are about to use is a Beta version of the ROS 2 Driver for Lynx and Panther. It is functional, and the architecture will not change significantly. Although it has been tested by the Husarion team, some stability issues and bugs may still occur.
>
> We would greatly appreciate your feedback regarding the Husarion UGV ROS 2 driver. You can reach us in the following ways:
>
> - By email at: [support@husarion.com](mailto:support@husarion.com)
> - Via our community forum: [Husarion Community](https://community.husarion.com)
> - By submitting an issue request on: [GitHub](https://github.com/husarion/panther_ros/issues)

## ROS 2 System Design

This section describes the ROS packages used in Husarion UGV. These packages are located in the [panther_ros](https://github.com/husarion/panther_ros) GitHub repository.

> [!NOTE]
> **Hardware Compatibility**
>
> This package supports **Lynx v0.2+**, **Panther v1.2+**. There may be small differences between robot models. This is caused by the hardware differences. Despite that, the ROS API was kept as closely matched between those revisions as possible and should be transparent in most of the use cases.

<!-- TODO: add this differences -->

The default way to communicate with our robots is via the Robot Operating System (ROS). All the drivers were written in ROS 2 framework. The ROS API is provided by ROS packages found in the GitHub repository [husarion/panther_ros](https://github.com/husarion/panther_ros). These packages are responsible for accessing the hardware components of the robot.

The graph below represents Husarion UVG ROS system. Some topics and services have been excluded from the graph for the sake of clarity.

![Husarion UVG ROS 2 System Design Diagram](.docs/ros2_system_design.drawio.svg)

## ROS Interfaces

Below is information about the physical robot API. For the simulation, topics and services are identical to the physical robot, but due to certain limitations, not all interfaces are present in the simulation.

| Symbol | Meaning                         |
| ------ | ------------------------------- |
| ü§ñ      | Available for physical robot    |
| üñ•Ô∏è      | Available in simulation         |
| ‚öôÔ∏è      | Requires specific configuration |
<!-- ‚öôÔ∏è - in future will be default and can be removed -->

### Nodes

| ü§ñ   | üñ•Ô∏è   | Node name                 | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| --- | --- | ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ‚úÖ   | ‚ùå   | `battery_driver`          | Publishes battery state read from ADC unit. <br/> [*panther_batter/battery_driver_node*](./husarion_ugv_battery/include/husarion_ugv_battery/battery_driver_node.hpp)                                                                                                                                                                                                                                                                                                                                                                 |
| ‚úÖ   | ‚úÖ   | `controller_manager`      | The Controller Manager performs two main functions. First, it manages controllers and their required interfaces, handling tasks like loading, activating, deactivating, and unloading. Second, it interacts with hardware components, ensuring access to their interfaces. This node manages the: `imu_broadcaster`, `joint_state_broadcaster`, `drive_controller`. <br/> *[controller_manager/controller_manager](https://github.com/ros-controls/ros2_control/blob/master/controller_manager)*                                      |
| ‚úÖ   | ‚úÖ   | `drive_controller`        | Manages mobile robots with a differential or mecanum drive depending on the configuration. It converts velocity commands for the robot body into wheel commands for the base. It also calculates odometry from hardware feedback and shares it. <br/> *[diff_drive_controller/diff_drive_controller](https://github.com/ros-controls/ros2_controllers/tree/master/diff_drive_controller) or [mecanum_drive_controller/mecanum_drive_controller](https://github.com/husarion/husarion_controllers/tree/main/mecanum_drive_controller)* |
| ‚úÖ   | ‚úÖ   | `ekf_filter`              | The Extended Kalman Filter node is designed to fuse odometry data from various sources, including wheel encoders, IMU, and GPS. <br/> *[robot_localization/ekf_filter](https://github.com/cra-ros-pkg/robot_localization)*                                                                                                                                                                                                                                                                                                            |
| ‚úÖ   | ‚ùå   | `gps`                     | Node responsible for parsing NMEA strings and publishing standard ROS NavSat message types. <br/> *[nmea_navsat_driver/nmea_navsat_driver](https://github.com/ros-drivers/nmea_navsat_driver/tree/ros2/src/libnmea_navsat_driver)*                                                                                                                                                                                                                                                                                                    |
| ‚ùå   | ‚úÖ   | `gz_bridge`               | Convert and transmit data between ROS and Gazebo <br/> *[ros_gz_bridge/parameter_bridge](https://github.com/gazebosim/ros_gz/tree/ros2/ros_gz_bridge)*                                                                                                                                                                                                                                                                                                                                                                                |
| ‚ùå   | ‚úÖ   | `gz_ros2_control`         | Responsible for integrating the ros2_control controller architecture with the Gazebo simulator. <br/> [gz_ros2_control/gz_ros2_control](https://github.com/ros-controls/gz_ros2_control/tree/master/gz_ros2_control/src)                                                                                                                                                                                                                                                                                                              |
| ‚ùå   | ‚úÖ   | `gz_estop_gui`            | The node is part of the Gazebo GUI plugin, enabling easy E-stop state modifications directly within the simulation. <br/> [husarion_ugv_gazebo/EStop](./husarion_ugv_gazebo/src/gui/e_stop.cpp)                                                                                                                                                                                                                                                                                                                                       |
| ‚úÖ   | ‚ùå   | `hardware_controller`     | Plugin responsible for communicating with engine controllers via the CAN bus and providing E-Stop functionalities. <br/> *[husarion_ugv_hardware_interfaces/{robot_model}System](./husarion_ugv_hardware_interfaces/src/robot_system/)*                                                                                                                                                                                                                                                                                               |
| ‚úÖ   | ‚úÖ   | `imu_broadcaster`         | Publishes readings of IMU sensors. <br/> *[imu_sensor_broadcaster/imu_sensor_broadcaster](https://github.com/ros-controls/ros2_controllers/tree/master/imu_sensor_broadcaster)*                                                                                                                                                                                                                                                                                                                                                       |
| ‚úÖ   | ‚úÖ   | `joint_state_broadcaster` | Reads all state interfaces and reports them on specific topics. <br/> *[joint_state_broadcaster/joint_state_broadcaster](https://github.com/ros-controls/ros2_controllers/tree/master/joint_state_broadcaster)*                                                                                                                                                                                                                                                                                                                       |
| ‚úÖ   | ‚úÖ   | `lights_container`        | Node for managing ROS components. This node manages: `lights_controller`, `lights_driver`. <br/>[*rclcpp_components/component_container*](https://github.com/ros2/rclcpp/tree/rolling/rclcpp_components)                                                                                                                                                                                                                                                                                                                              |
| ‚úÖ   | ‚úÖ   | `lights_controller`       | This node is responsible for processing animations and publishing frames to `light_driver` node. <br/> [*husarion_ugv_lights/LightsControllerNode*](./husarion_ugv_lights/include/husarion_ugv_lights/lights_controller_node.hpp)                                                                                                                                                                                                                                                                                                     |
| ‚úÖ   | ‚ùå   | `lights_driver`           | This node is responsible for displaying frames on the robot's lights. <br/> [*husarion_ugv_lights/LightsDriverNode*](./husarion_ugv_lights/include/husarion_ugv_lights/lights_driver_node.hpp)                                                                                                                                                                                                                                                                                                                                        |
| ‚úÖ   | ‚úÖ   | `lights_manager`          | Node responsible for managing lights animation scheduling. <br/> [husarion_ugv_manager/lights_manager](./husarion_ugv_manager/include/husarion_ugv_manager/lights_manager_node.hpp)                                                                                                                                                                                                                                                                                                                                                   |
| ‚úÖ   | ‚úÖ   | ‚öôÔ∏è `navsat_transform`  ‚öôÔ∏è   | It converts raw GPS data into odometry data and publishes corrected GPS positions based on sensor data at a higher frequency. <br/> *[robot_localization/navsat_transform](https://github.com/cra-ros-pkg/robot_localization)*                                                                                                                                                                                                                                                                                                        |
| ‚úÖ   | ‚úÖ   | `robot_state_publisher`   | Broadcasts a robot's state to tf2 using a provided URDF model and joint states. It updates the model and broadcasts poses for fixed and movable joints to tf2 topics. <br/> *[robot_state_publisher/robot_state_publisher](https://github.com/ros/robot_state_publisher)*                                                                                                                                                                                                                                                             |
| ‚úÖ   | ‚ùå   | `safety_manager`          | Node responsible for managing safety features, and software shutdown of components. <br/> *[husarion_ugv_manager/safety_manager_node](./husarion_ugv_manager/include/husarion_ugv_manager/safety_manager_node.hpp)*                                                                                                                                                                                                                                                                                                                   |
| ‚úÖ   | ‚ùå   | `system_monitor`          | Publishes system state of the Built-in Computer such as CPU usage, RAM memory usage, disk usage and  CPU temperature. <br/> *[husarion_ugv_diagnostics/system_monitor_node](./husarion_ugv_diagnostics/include/husarion_ugv_diagnostics/system_monitor_node.hpp)*                                                                                                                                                                                                                                                                     |

### Topics

| ü§ñ   | üñ•Ô∏è   | Topic                         | Description                                                                                                                                                                                                                                                                                                                                                               |
| --- | --- | ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ‚úÖ   | ‚úÖ   | `battery/battery_status`      | Mean values of both batteries will be published if the robot has two batteries. Otherwise, the state of the single battery will be published.<br/> [*sensor_msgs/BatteryState*](https://docs.ros2.org/latest/api/sensor_msgs/msg/BatteryState.html)                                                                                                                       |
| ‚úÖ   | ‚ùå   | `battery/charging_status`     | Battery charging status value.<br/> [*panther_msgs/ChargingStatus*](https://github.com/husarion/panther_msgs)                                                                                                                                                                                                                                                             |
| ‚úÖ   | ‚úÖ   | `cmd_vel`                     | Command velocity value.<br/> [*geometry_msgs/Twist*](https://docs.ros2.org/latest/api/geometry_msgs/msg/Twist.html)                                                                                                                                                                                                                                                       |
| ‚úÖ   | ‚úÖ   | `diagnostics`                 | Diagnostic data.<br/> [*diagnostic_msgs/DiagnosticArray*](https://docs.ros2.org/latest/api/diagnostic_msgs/msg/DiagnosticArray.html)                                                                                                                                                                                                                                      |
| ‚úÖ   | ‚úÖ   | `dynamic_joint_states`        | Information about the state of various movable joints in a robotic system.<br/> [*control_msgs/DynamicJointState*](https://github.com/ros-controls/control_msgs/blob/master/control_msgs/msg/DynamicJointState.msg)                                                                                                                                                       |
| ‚úÖ   | ‚úÖ   | ‚öôÔ∏è `gps/filtered` ‚öôÔ∏è            | Filtered GPS position after fusing odometry data.<br/> [*sensor_msgs/NavSatFix*](https://docs.ros2.org/latest/api/sensor_msgs/msg/NavSatFix.html)                                                                                                                                                                                                                         |
| ‚úÖ   | ‚úÖ   | ‚öôÔ∏è `gps/fix` ‚öôÔ∏è                 | Raw GPS data.<br/> [*sensor_msgs/NavSatFix*](https://docs.ros2.org/latest/api/sensor_msgs/msg/NavSatFix.html)                                                                                                                                                                                                                                                             |
| ‚úÖ   | ‚ùå   | `gps/time_reference`          | The timestamp from the GPS device.<br/> [*sensor_msgs/TimeReference*](https://docs.ros2.org/latest/api/sensor_msgs/msg/TimeReference.html)                                                                                                                                                                                                                                |
| ‚úÖ   | ‚ùå   | `gps/vel`                     | Velocity output from the GPS device.<br/> [*geometry_msgs/TwistStamped*](https://docs.ros2.org/latest/api/geometry_msgs/msg/TwistStamped.html)                                                                                                                                                                                                                            |
| ‚úÖ   | ‚úÖ   | `hardware/e_stop`             | Current E-stop state.<br/> [*std_msgs/Bool*](https://docs.ros2.org/latest/api/std_msgs/msg/Bool.html).                                                                                                                                                                                                                                                                    |
| ‚úÖ   | ‚ùå   | `hardware/io_state`           | Current IO state.<br/> [*panther_msgs/IOState*](https://github.com/husarion/panther_msgs)                                                                                                                                                                                                                                                                                 |
| ‚úÖ   | ‚úÖ   | `hardware/robot_driver_state` | Current motor controllers' state and error flags. Subscribed if using Roboteq motor controllers data.<br/> [*panther_msgs/RobotDriverState*](https://github.com/husarion/panther_msgs)                                                                                                                                                                                    |
| ‚úÖ   | ‚úÖ   | `imu/data`                    | Filtered IMU data.<br/> [*sensor_msgs/Imu*](https://docs.ros2.org/latest/api/sensor_msgs/msg/Imu.html)                                                                                                                                                                                                                                                                    |
| ‚úÖ   | ‚úÖ   | `joint_states`                | Provides information about the state of various joints in a robotic system.<br/> [*sensor_msgs/JointState*](https://docs.ros2.org/latest/api/sensor_msgs/msg/JointState.html)                                                                                                                                                                                             |
| ‚úÖ   | ‚úÖ   | `lights/channel_1_frame`      | Frame to be displayed on robot Front Bumper Lights.<br/> [*sensor_msgs/Image*](https://docs.ros2.org/latest/api/sensor_msgs/msg/Image.html)                                                                                                                                                                                                                               |
| ‚úÖ   | ‚úÖ   | `lights/channel_2_frame`      | Frame to be displayed on robot Rear Bumper Lights.<br/> [*sensor_msgs/Image*](https://docs.ros2.org/latest/api/sensor_msgs/msg/Image.html)                                                                                                                                                                                                                                |
| ‚úÖ   | ‚úÖ   | `localization/set_pose`       | Sets the pose of the EKF node.<br/> [*geometry_msgs/PoseWithCovarianceStamped*](https://docs.ros2.org/latest/api/geometry_msgs/msg/PoseWithCovarianceStamped.html)                                                                                                                                                                                                        |
| ‚úÖ   | ‚úÖ   | `odometry/filtered`           | Contains information about the filtered position and orientation. When `localization_mode` is `relative`, the position and orientation are relative to the starting point. When `localization_mode` is `enu`, the orientation is relative to the east-north-up (ENU) coordinates.<br/> [*nav_msgs/Odometry*](https://docs.ros2.org/latest/api/nav_msgs/msg/Odometry.html) |
| ‚úÖ   | ‚úÖ   | `odometry/wheels`             | Robot odometry calculated from wheels.<br/> [*nav_msgs/Odometry*](https://docs.ros2.org/latest/api/nav_msgs/msg/Odometry.html)                                                                                                                                                                                                                                            |
| ‚úÖ   | ‚úÖ   | `robot_description`           | Contains information about robot description from URDF file. <br/> [*std_msgs/String*](https://docs.ros2.org/latest/api/std_msgs/msg/String.html)                                                                                                                                                                                                                         |
| ‚úÖ   | ‚ùå   | `system_status`               | State of the system, including Built-in Computer's CPU temperature and load. <br/> [*panther_msgs/SystemStatus*](https://github.com/husarion/panther_msgs)                                                                                                                                                                                                                |
| ‚úÖ   | ‚úÖ   | `tf`                          | Transforms of robot system.<br/> [*tf2_msgs/TFMessage*](https://docs.ros2.org/latest/api/tf2_msgs/msg/TFMessage.html)                                                                                                                                                                                                                                                     |
| ‚úÖ   | ‚úÖ   | `tf_static`                   | Static transforms of robot system.<br/> [*tf2_msgs/TFMessage*](https://docs.ros2.org/latest/api/tf2_msgs/msg/TFMessage.html)                                                                                                                                                                                                                                              |

#### Hidden topics

| ü§ñ   | üñ•Ô∏è   | Topic                           | Description                                                                                                                                                            |
| --- | --- | ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ‚úÖ   | ‚ùå   | `_battery/battery_1_status_raw` | First battery raw state. <br/> [_sensor_msgs/BatteryState_](https://docs.ros2.org/latest/api/sensor_msgs/msg/BatteryState.html)                                        |
| ‚úÖ   | ‚ùå   | `_battery/battery_2_status_raw` | Second battery raw state. Published if second battery detected. <br/> [_sensor_msgs/BatteryState_](https://docs.ros2.org/latest/api/sensor_msgs/msg/BatteryState.html) |
| ‚úÖ   | ‚ùå   | `_gps/heading`                  | Not supported for current configuration. <br/> [_geometry_msgs/QuaternionStamped_](https://docs.ros2.org/latest/api/geometry_msgs/msg/QuaternionStamped.html)          |
| ‚úÖ   | ‚úÖ   | ‚öôÔ∏è `_odometry/gps` ‚öôÔ∏è             | Transformed raw GPS data to odometry format. <br/> [_nav_msgs/Odometry_](https://docs.ros2.org/latest/api/nav_msgs/msg/Odometry.html)                                  |

### Services

| ü§ñ   | üñ•Ô∏è   | Service                                           | Description                                                                                                                                                                                             |
| --- | --- | ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ‚úÖ   | ‚úÖ   | `controller_manager/configure_controller`         | Manage lifecycle transition. <br/> [controller_manager_msgs/srv/ConfigureController](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                                  |
| ‚úÖ   | ‚úÖ   | `controller_manager/list_controller_types`        | Output the available controller types and their base classes. <br/> [controller_manager_msgs/srv/ListControllerTypes](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs) |
| ‚úÖ   | ‚úÖ   | `controller_manager/list_controllers`             | Output the list of loaded controllers, their type and status. <br/> [controller_manager_msgs/srv/ListControllers](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)     |
| ‚úÖ   | ‚úÖ   | `controller_manager/list_hardware_components`     | Output the list of available hardware components. <br/> [controller_manager_msgs/srv/ListHardwareComponents](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)          |
| ‚úÖ   | ‚úÖ   | `controller_manager/list_hardware_interfaces`     | Output the list of available command and state interfaces. <br/> [controller_manager_msgs/srv/ListHardwareInterfaces](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs) |
| ‚úÖ   | ‚úÖ   | `controller_manager/load_controller`              | Load a controller in a controller manager. <br/> [controller_manager_msgs/srv/LoadController](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                         |
| ‚úÖ   | ‚úÖ   | `controller_manager/reload_controller_libraries`  | Reload controller libraries. <br/> [controller_manager_msgs/srv/ReloadControllerLibraries](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                            |
| ‚úÖ   | ‚úÖ   | `controller_manager/set_hardware_component_state` | Adjust the state of the hardware component. <br/> [controller_manager_msgs/srv/SetHardwareComponentState](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)             |
| ‚úÖ   | ‚úÖ   | `controller_manager/switch_controller`            | Switch controllers in a controller manager. <br/> [controller_manager_msgs/srv/SwitchController](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                      |
| ‚úÖ   | ‚úÖ   | `controller_manager/unload_controller`            | Unload a controller in a controller manager. <br/> [controller_manager_msgs/srv/UnloadController](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                     |
| ‚úÖ   | ‚ùå   | `hardware/aux_power_enable`                       | Enables or disables AUX power. <br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                                 |
| ‚úÖ   | ‚ùå   | `hardware/charger_enable`                         | Enables or disables external charger. <br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                          |
| ‚úÖ   | ‚ùå   | `hardware/digital_power_enable`                   | Enables or disables digital power. <br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                             |
| ‚úÖ   | ‚úÖ   | `hardware/e_stop_reset`                           | Resets E-stop. <br/> [std_srvs/srv/Trigger](https://docs.ros2.org/latest/api/std_srvs/srv/Trigger.html)                                                                                                 |
| ‚úÖ   | ‚úÖ   | `hardware/e_stop_trigger`                         | Triggers E-stop. <br/> [std_srvs/srv/Trigger](https://docs.ros2.org/latest/api/std_srvs/srv/Trigger.html)                                                                                               |
| ‚úÖ   | ‚ùå   | `hardware/fan_enable`                             | Enables or disables fan. <br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                                       |
| ‚úÖ   | ‚ùå   | `hardware/motor_power_enable`                     | Enables or disables motor power. <br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                               |
| ‚úÖ   | ‚úÖ   | `lights/set_animation`                            | Sets LED animation. <br/> [panther_msgs/srv/SetLEDAnimation](https://github.com/husarion/panther_msgs)                                                                                                  |
| ‚úÖ   | ‚úÖ   | `localization/enable`                             | Enable EKF node. <br/> [std_srvs/srv/Empty](https://docs.ros2.org/latest/api/std_srvs/srv/Empty.html)                                                                                                   |
| ‚úÖ   | ‚ùå   | `lights/set_brightness`                           | Sets global LED brightness, value ranges from **0.0** to **1.0**. <br/> [panther_msgs/SetLEDBrightness](https://github.com/husarion/panther_msgs)                                                       |
| ‚úÖ   | ‚úÖ   | `localization/set_pose`                           | Set pose of EKF node. <br/> [robot_localization/srv/SetPose](https://github.com/cra-ros-pkg/robot_localization/tree/ros2)                                                                               |
| ‚úÖ   | ‚úÖ   | `localization/toggle`                             | Toggle filter processing in the EKF node. <br/> [robot_localization/srv/ToggleFilterProcessing](https://github.com/cra-ros-pkg/robot_localization/tree/ros2)                                            |
