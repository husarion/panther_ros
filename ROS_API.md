# ROS API

> [!IMPORTANT]
> **Beta Release**
>
> Please be advised that the software you are about to use is a Beta version of the ROS 2 Driver for Panther. It is functional, and the architecture will not change significantly. Although it has been tested by the Husarion team, some stability issues and bugs may still occur.
>
> We would greatly appreciate your feedback regarding the Panther ROS 2 driver. You can reach us in the following ways:
>
> - By email at: [support@husarion.com](mailto:support@husarion.com)
> - Via our community forum: [Husarion Community](https://community.husarion.com)
> - By submitting an issue request on: [GitHub](https://github.com/husarion/panther_ros/issues)

## ROS 2 System Design

This section describes the ROS packages in the Panther ROS system. These packages are located in the [panther_ros](https://github.com/husarion/panther_ros) GitHub repository.

> [!NOTE]
> **Differences in ROS System**
>
> ROS 2 nodes differs slightly between **Panther v1.06** and **Panther v1.2+**. This is caused by internal hardware differences. Despite that, the ROS API was kept as closely matched between those revisions as possible and should be transparent in most of the use cases.

<!-- TODO: add this differences -->

The default way to communicate with Panther's hardware is via the Robot Operating System (ROS). All the drivers were written in ROS 2 framework. The ROS API is provided by ROS packages found in the GitHub repository [husarion/panther_ros](https://github.com/husarion/panther_ros). These packages are responsible for accessing the hardware components of the robot.

The graph below represents Panther's ROS system. Some topics and services have been excluded from the graph for the sake of clarity.

![Panther ROS 2 API Diagram](.docs/panther_ros2_api.drawio.svg)

## ROS Interfaces

Below is information about the physical robot API. For the simulation, topics and services are identical to the physical robot, but due to certain limitations, not all interfaces are present in the simulation.

| Symbol | Meaning                         |
| ------ | ------------------------------- |
| ü§ñ      | Available for physical robot    |
| üñ•Ô∏è      | Available in simulation         |
| ‚öôÔ∏è      | Requires specific configuration |

### Nodes

|     | Node name                 | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| --- | ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ü§ñ   | `battery_driver`          | Publishes battery state read from ADC unit for Panther version 1.2 and above, or based on Roboteq motor controllers' data for earlier versions of the robot. <br/> [*panther_batter/battery_driver_node*](./panther_battery/include/panther_battery/battery_driver_node.hpp)                                                                                                                                                                                                                                                                              |
| ü§ñüñ•Ô∏è  | `controller_manager`      | The Controller Manager performs two main functions. First, it manages controllers and their required interfaces, handling tasks like loading, activating, deactivating, and unloading. Second, it interacts with hardware components, ensuring access to their interfaces. This node manages the: `imu_broadcaster`, `joint_state_broadcaster`, `drive_controller`. <br/> *[controller_manager/controller_manager](https://github.com/ros-controls/ros2_control/blob/master/controller_manager)*                                      |
| ü§ñüñ•Ô∏è  | `drive_controller`        | Manages mobile robots with a differential or mecanum drive depending on the configuration. It converts velocity commands for the robot body into wheel commands for the base. It also calculates odometry from hardware feedback and shares it. <br/> *[diff_drive_controller/diff_drive_controller](https://github.com/ros-controls/ros2_controllers/tree/master/diff_drive_controller) or [mecanum_drive_controller/mecanum_drive_controller](https://github.com/husarion/husarion_controllers/tree/main/mecanum_drive_controller)* |
| ü§ñüñ•Ô∏è  | `ekf_filter`              | The Extended Kalman Filter node is designed to fuse odometry data from various sources, including wheel encoders, IMU, and GPS. <br/> *[robot_localization/ekf_filter](https://github.com/cra-ros-pkg/robot_localization)*                                                                                                                                                                                                                                                                                                            |
| ü§ñ   | `hardware_controller`     | Plugin responsible for communicating with engine controllers via the CAN bus and providing E-Stop functionalities. <br/> *[panther_hardware_interfaces/PantherSystem](./panther_hardware_interfaces/src/panther_system/)*                                                                                                                                                                                                                                                                                                             |
| ü§ñ   | `gps`                     | Node responsible for parsing NMEA strings and publishing standard ROS NavSat message types. <br/> *[nmea_navsat_driver/nmea_navsat_driver](https://github.com/ros-drivers/nmea_navsat_driver/tree/ros2/src/libnmea_navsat_driver)*                                                                                                                                                                                                                                                                                                                                 |
| üñ•Ô∏è   | `gz_ros2_control`         | Responsible for integrating the ros2_control controller architecture with the Gazebo simulator. <br/> [gz_ros2_control/gz_ros2_control](https://github.com/ros-controls/gz_ros2_control/tree/master/gz_ros2_control/src)                                                                                                                                                                                                                                                                                                              |
| üñ•Ô∏è   | `gz_estop_gui`            | The node is part of the Gazebo GUI plugin, enabling easy E-stop state modifications directly within the simulation. <br/> [panther_gazebo/EStop](./panther_gazebo/src/gui/e_stop.cpp)                                                                                                                                                                                                                                                                                |
| ü§ñüñ•Ô∏è  | `imu_broadcaster`         | Publishes readings of IMU sensors. <br/> *[imu_sensor_broadcaster/imu_sensor_broadcaster](https://github.com/ros-controls/ros2_controllers/tree/master/imu_sensor_broadcaster)*                                                                                                                                                                                                                                                                                                                                                       |
| ü§ñüñ•Ô∏è  | `joint_state_broadcaster` | Reads all state interfaces and reports them on specific topics. <br/> *[joint_state_broadcaster/joint_state_broadcaster](https://github.com/ros-controls/ros2_controllers/tree/master/joint_state_broadcaster)*                                                                                                                                                                                                                                                                                                                       |
| ü§ñüñ•Ô∏è  | `lights_container`        | Node for managing ROS components. This node manages: `lights_controller`, `lights_driver`. <br/>[*rclcpp_components/component_container*](https://github.com/ros2/rclcpp/tree/rolling/rclcpp_components)                                                                                                                                                                                                                                                                                                                              |
| ü§ñüñ•Ô∏è  | `lights_controller`       | This node is responsible for processing animations and publishing frames to be displayed on the Husarion Panther robot Bumper Lights. <br/> [*panther_lights/LightsControllerNode*](./panther_lights/include/panther_lights/lights_controller_node.hpp)                                                                                                                                                                                                                                                                                                  |
| ü§ñ   | `lights_driver`           | This node is responsible for displaying frames on the Husarion Panther robot's Bumper Lights. <br/> [*panther_lights/LightsDriverNode*](./panther_lights/include/panther_lights/lights_driver_node.hpp)                                                                                                                                                                                                                                                                                                                                                  |
| ü§ñüñ•Ô∏è  | `lights_manager`          | Node responsible for managing Bumper Lights animation scheduling. <br/> [panther_manager/lights_manager](./panther_manager/include/panther_manager/lights_manager_node.hpp)                                                                                                                                                                                                                                                                                                                                                                               |
| ü§ñüñ•Ô∏è‚öôÔ∏è | `navsat_transform`        | It converts raw GPS data into odometry data and publishes corrected GPS positions based on sensor data at a higher frequency. <br/> *[robot_localization/navsat_transform](https://github.com/cra-ros-pkg/robot_localization)*                                                                                                                                                                                                                                                                                                        |
| üñ•Ô∏è   | `panther_base_gz_bridge`  | Convert and transmit data between ROS and Gazebo <br/> *[ros_gz_bridge/parameter_bridge](https://github.com/gazebosim/ros_gz/tree/ros2/ros_gz_bridge)*                                                                                                                                                                                                                                                                                                                                                                                |
| ü§ñüñ•Ô∏è  | `robot_state_publisher`   | Broadcasts a robot's state to tf2 using a provided URDF model and joint states. It updates the model and broadcasts poses for fixed and movable joints to tf2 topics. <br/> *[robot_state_publisher/robot_state_publisher](https://github.com/ros/robot_state_publisher)*                                                                                                                                                                                                                                                             |
| ü§ñ   | `safety_manager`          | Node responsible for managing safety features, and software shutdown of components. <br/> *[panther_manager/safety_manager_node](./panther_manager/include/panther_manager/safety_manager_node.hpp)*                                                                                                                                                                                                                                                                                                                                                      |
| ü§ñ   | `system_monitor`          | Publishes system state of the Built-in Computer such as CPU usage, RAM memory usage, disk usage and  CPU temperature. <br/> *[panther_diagnostic/system_monitor_node](./panther_diagnostics/include/panther_diagnostics/system_monitor_node.hpp)*                                                                                                                                                                                                                                                                                                             |

### Topics

|     | Topic                              | Description                                                                                                                                                                                                                                                                                                                                                               |
| --- | ---------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ü§ñüñ•Ô∏è  | `battery/battery_status`           | Mean values of both batteries if Panther has two batteries. Otherwise, the state of the single battery will be published.<br/> [*sensor_msgs/BatteryState*](https://docs.ros2.org/latest/api/sensor_msgs/msg/BatteryState.html)                                                                                                                                           |
| ü§ñ   | `battery/charging_status`          | Battery charging status value.<br/> [*panther_msgs/ChargingStatus*](https://github.com/husarion/panther_msgs)                                                                                                                                                                                                                                                             |
| ü§ñüñ•Ô∏è  | `cmd_vel`                          | Command velocity value.<br/> [*geometry_msgs/Twist*](https://docs.ros2.org/latest/api/geometry_msgs/msg/Twist.html)                                                                                                                                                                                                                                                       |
| ü§ñüñ•Ô∏è  | `diagnostics`                      | Diagnostic data.<br/> [*diagnostic_msgs/DiagnosticArray*](https://docs.ros2.org/latest/api/diagnostic_msgs/msg/DiagnosticArray.html)                                                                                                                                                                                                                                      |
| ü§ñüñ•Ô∏è  | `dynamic_joint_states`             | Information about the state of various movable joints in a robotic system.<br/> [*control_msgs/DynamicJointState*](https://github.com/ros-controls/control_msgs/blob/master/control_msgs/msg/DynamicJointState.msg)                                                                                                                                                       |
| ü§ñüñ•Ô∏è‚öôÔ∏è | `gps/filtered`                     | Filtered GPS position after fusing odometry data.<br/> [*sensor_msgs/NavSatFix*](https://docs.ros2.org/latest/api/sensor_msgs/msg/NavSatFix.html)                                                                                                                                                                                                                         |
| ü§ñüñ•Ô∏è‚öôÔ∏è | `gps/fix`                          | Raw GPS data.<br/> [*sensor_msgs/NavSatFix*](https://docs.ros2.org/latest/api/sensor_msgs/msg/NavSatFix.html)                                                                                                                                                                                                                                                             |
| ü§ñ   | `gps/time_reference`                | The timestamp from the GPS device.<br/> [*sensor_msgs/TimeReference*](https://docs.ros2.org/latest/api/sensor_msgs/msg/TimeReference.html) |
| ü§ñ   | `gps/vel`                           | Velocity output from the GPS device.<br/> [*geometry_msgs/TwistStamped*](https://docs.ros2.org/latest/api/geometry_msgs/msg/TwistStamped.html) |
| ü§ñüñ•Ô∏è  | `hardware/e_stop`                  | Current E-stop state.<br/> [*std_msgs/Bool*](https://docs.ros2.org/latest/api/std_msgs/msg/Bool.html).                                                                                                                                                                                                                                                               |
| ü§ñ   | `hardware/io_state`                | Current IO state.<br/> [*panther_msgs/IOState*](https://github.com/husarion/panther_msgs)                                                                                                                                                                                                                                                                                 |
| ü§ñüñ•Ô∏è  | `hardware/robot_driver_state` | Current motor controllers' state and error flags. Subscribed if using Roboteq motor controllers data.<br/> [*panther_msgs/RobotDriverState*](https://github.com/husarion/panther_msgs)                                                                                                                                                                                         |
| ü§ñüñ•Ô∏è  | `imu/data`                         | Filtered IMU data.<br/> [*sensor_msgs/Imu*](https://docs.ros2.org/latest/api/sensor_msgs/msg/Imu.html)                                                                                                                                                                                                                                                                    |
| ü§ñüñ•Ô∏è  | `joint_states`                     | Provides information about the state of various joints in a robotic system.<br/> [*sensor_msgs/JointState*](https://docs.ros2.org/latest/api/sensor_msgs/msg/JointState.html)                                                                                                                                                                                             |
| ü§ñüñ•Ô∏è  | `lights/channel_1_frame`           | Frame to be displayed on robot Front Bumper Lights.<br/> [*sensor_msgs/Image*](https://docs.ros2.org/latest/api/sensor_msgs/msg/Image.html)                                                                                                                                                                                                                               |
| ü§ñüñ•Ô∏è  | `lights/channel_2_frame`           | Frame to be displayed on robot Rear Bumper Lights.<br/> [*sensor_msgs/Image*](https://docs.ros2.org/latest/api/sensor_msgs/msg/Image.html)                                                                                                                                                                                                                                |
| ü§ñüñ•Ô∏è  | `localization/set_pose`            | Sets the pose of the EKF node.<br/> [*geometry_msgs/PoseWithCovarianceStamped*](https://docs.ros2.org/latest/api/geometry_msgs/msg/PoseWithCovarianceStamped.html)                                                                                                                                                                                                        |
| ü§ñüñ•Ô∏è  | `odometry/filtered`                | Contains information about the filtered position and orientation. When `localization_mode` is `relative`, the position and orientation are relative to the starting point. When `localization_mode` is `enu`, the orientation is relative to the east-north-up (ENU) coordinates.<br/> [*nav_msgs/Odometry*](https://docs.ros2.org/latest/api/nav_msgs/msg/Odometry.html) |
| ü§ñüñ•Ô∏è  | `odometry/wheels`                  | Robot odometry calculated from wheels.<br/> [*nav_msgs/Odometry*](https://docs.ros2.org/latest/api/nav_msgs/msg/Odometry.html)                                                                                                                                                                                                                                            |
| ü§ñüñ•Ô∏è  | `robot_description`                | Contains information about robot description from URDF file. <br/> [*std_msgs/String*](https://docs.ros2.org/latest/api/std_msgs/msg/String.html)                                                                                                                                                                                                                         |
| ü§ñ   | `system_status`                    | State of the system, including Built-in Computer's CPU temperature and load. <br/> [*panther_msgs/SystemStatus*](https://github.com/husarion/panther_msgs)                                                                                                                                                                                                                |
| ü§ñüñ•Ô∏è  | `tf`                               | Transforms of robot system.<br/> [*tf2_msgs/TFMessage*](https://docs.ros2.org/latest/api/tf2_msgs/msg/TFMessage.html)                                                                                                                                                                                                                                                     |
| ü§ñüñ•Ô∏è  | `tf_static`                        | Static transforms of robot system.<br/> [*tf2_msgs/TFMessage*](https://docs.ros2.org/latest/api/tf2_msgs/msg/TFMessage.html)                                                                                                                                                                                                                                              |

#### Hidden topics

|     | Topic                           | Description                                                                                                                                                           |
| --- | ------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ü§ñ   | `_battery/battery_1_status_raw` | First battery raw state.<br/> [*sensor_msgs/BatteryState*](https://docs.ros2.org/latest/api/sensor_msgs/msg/BatteryState.html)                                        |
| ü§ñ   | `_battery/battery_2_status_raw` | Second battery raw state. Published if second battery detected.<br/> [*sensor_msgs/BatteryState*](https://docs.ros2.org/latest/api/sensor_msgs/msg/BatteryState.html) |
| ü§ñ   | `_gps/heading`                       | Not supported for current configuration.<br/> [*geometry_msgs/QuaternionStamped*](https://docs.ros2.org/latest/api/geometry_msgs/msg/QuaternionStamped.html)|
| ü§ñüñ•Ô∏è‚öôÔ∏è | `_odometry/gps`                 | Transformed raw GPS data to odometry format.<br/> [*nav_msgs/Odometry*](https://docs.ros2.org/latest/api/nav_msgs/msg/Odometry.html)                                  |

### Services

|     | Service                                           | Description                                                                                                                                                                                            |
| --- | ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| ü§ñüñ•Ô∏è  | `controller_manager/configure_controller`         | Manage lifecycle transition.<br/> [controller_manager_msgs/srv/ConfigureController](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                                  |
| ü§ñüñ•Ô∏è  | `controller_manager/list_controller_types`        | Output the available controller types and their base classes.<br/> [controller_manager_msgs/srv/ListControllerTypes](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs) |
| ü§ñüñ•Ô∏è  | `controller_manager/list_controllers`             | Output the list of loaded controllers, their type and status.<br/> [controller_manager_msgs/srv/ListControllers](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)     |
| ü§ñüñ•Ô∏è  | `controller_manager/list_hardware_components`     | Output the list of available hardware components.<br/> [controller_manager_msgs/srv/ListHardwareComponents](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)          |
| ü§ñüñ•Ô∏è  | `controller_manager/list_hardware_interfaces`     | Output the list of available command and state interfaces.<br/> [controller_manager_msgs/srv/ListHardwareInterfaces](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs) |
| ü§ñüñ•Ô∏è  | `controller_manager/load_controller`              | Load a controller in a controller manager.<br/> [controller_manager_msgs/srv/LoadController](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                         |
| ü§ñüñ•Ô∏è  | `controller_manager/reload_controller_libraries`  | Reload controller libraries.<br/> [controller_manager_msgs/srv/ReloadControllerLibraries](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                            |
| ü§ñüñ•Ô∏è  | `controller_manager/set_hardware_component_state` | Adjust the state of the hardware component.<br/> [controller_manager_msgs/srv/SetHardwareComponentState](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)             |
| ü§ñüñ•Ô∏è  | `controller_manager/switch_controller`            | Switch controllers in a controller manager.<br/> [controller_manager_msgs/srv/SwitchController](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                      |
| ü§ñüñ•Ô∏è  | `controller_manager/unload_controller`            | Unload a controller in a controller manager.<br/> [controller_manager_msgs/srv/UnloadController](https://github.com/ros-controls/ros2_control/tree/master/controller_manager_msgs)                     |
| ü§ñ   | `hardware/aux_power_enable`                       | Enables or disables AUX power.<br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                                 |
| ü§ñ   | `hardware/charger_enable`                         | Enables or disables external charger.<br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                          |
| ü§ñ   | `hardware/digital_power_enable`                   | Enables or disables digital power.<br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                             |
| ü§ñüñ•Ô∏è  | `hardware/e_stop_reset`                           | Resets E-stop.<br/> [std_srvs/srv/Trigger](https://docs.ros2.org/latest/api/std_srvs/srv/Trigger.html)                                                                                                 |
| ü§ñüñ•Ô∏è  | `hardware/e_stop_trigger`                         | Triggers E-stop.<br/> [std_srvs/srv/Trigger](https://docs.ros2.org/latest/api/std_srvs/srv/Trigger.html)                                                                                               |
| ü§ñ   | `hardware/fan_enable`                             | Enables or disables fan.<br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                                       |
| ü§ñ   | `hardware/motor_power_enable`                     | Enables or disables motor power.<br/> [std_srvs/srv/SetBool](https://docs.ros2.org/latest/api/std_srvs/srv/SetBool.html)                                                                               |
| ü§ñüñ•Ô∏è  | `lights/set_animation`                            | Sets LED animation.<br/> [panther_msgs/srv/SetLEDAnimation](https://github.com/husarion/panther_msgs)                                                                                                  |
| ü§ñ   | `lights/set_brightness`                           | Sets global LED brightness, value ranges from **0.0** to **1.0**.<br/> [panther_msgs/SetLEDBrightness](https://github.com/husarion/panther_msgs)                                                       |
| ü§ñüñ•Ô∏è  | `localization/enable`                             | Enable EKF node.<br/> [std_srvs/srv/Empty](https://docs.ros2.org/latest/api/std_srvs/srv/Empty.html)                                                                                                   |
| ü§ñüñ•Ô∏è  | `localization/set_pose`                           | Set pose of EKF node.<br/> [robot_localization/srv/SetPose](https://github.com/cra-ros-pkg/robot_localization/tree/ros2)                                                                               |
| ü§ñüñ•Ô∏è  | `localization/toggle`                             | Toggle filter processing in the EKF node.<br/> [robot_localization/srv/ToggleFilterProcessing](https://github.com/cra-ros-pkg/robot_localization/tree/ros2)                                            |
